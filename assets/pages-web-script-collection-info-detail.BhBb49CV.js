import{e as t,C as e,u as i,z as o,y as a,l,c as s,w as c,i as r,o as n,a as d,b as h,f,t as u,A as m,F as p,r as _,H as g,g as C,M as w,ae as b,$ as y}from"./index-4EZ8v3QT.js";import{_ as v}from"./uni-icons.5yTMgLsQ.js";import{r as k}from"./uni-app.es.Bc_DzAQZ.js";import{_ as S}from"./bannerScript.DCwArTGE.js";import{s as D}from"./store.D7g1bi5i.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-dateformat.BSryRunN.js";const x=t.database(),F=x.command;const j=I({components:{bannerScript:S},data:()=>({collectionData:{name:"加载中...",description:""},rawCollection:[],showEditDialog:!1,activeIndex:-1,originalOrder:[],firstSort:[],hasChanged:!1,areaHeight:0,editForm:{name:"",description:""},collectionList:"web-script-collection-info",_id:"",userInfo:null}),computed:{filteredCollection(){return this.rawCollection.filter((t=>!!t.id))}},watch:{filteredCollection:{handler(t){this.calcAreaHeight(t)},immediate:!0}},onLoad(t){this._id=t.id||"67bccc6f47ea33825d4b8d7e",this.initData(),this.userInfo=D.userInfo},methods:{sort(){this.hasChanged=this.rawCollection.filter((t=>this.firstSort.find((e=>e._id==t._id)).sort!=t.sort)).length,this.rawCollection.sort(((t,e)=>e.sort-t.sort))},async initData(){await Promise.all([this.loadCollectionInfo(),this.loadScripts()]),this.$nextTick((()=>{this.originalOrder=[...this.filteredCollection]}))},async loadCollectionInfo(){try{const{result:t}=await x.collection("web-script-collection-info").doc(this._id).get();this.collectionData=t.data[0],this.editForm={...t.data[0]}}catch(t){console.error(" 加载合集信息失败:",t),e({title:"数据加载失败",icon:"error"})}},async loadScripts(){try{const t=await x.collection("web-script-collection").where({collect_id:this._id}).orderBy("sort","desc").get(),e=t.result.data.map((t=>({id:t.id,host:t.host,show:F.gt(0)})));if(e.length){const i=await x.collection("web-script").where(F.or(e)).field({id:!0,name:!0,description:!0,publisher:!0,"update-id":!0,host:!0,publish_date:!0,day:!0,total:!0,user_id:!0,create_date:!0,version:!0,userContentHtml:!0,changelog:!0,show:!0}).get();this.rawCollection=i.result.data.map((e=>{var i=t.result.data.find((t=>t.id==e.id&&t.host==e.host));return e.sort=i?i.sort:0,e})),console.log("排序",this.rawCollection),this.firstSort=this.rawCollection.map((t=>({_id:t._id,sort:t.sort})))}}catch(t){console.error(" 加载脚本失败:",t),e({title:"脚本加载失败",icon:"error"})}},calcAreaHeight(t=[]){this.areaHeight=2015*t.length},handleTouchStart(t){this.activeIndex=t,this.originalOrder=[...this.filteredCollection]},handleTouchEnd(){this.activeIndex=-1,this.checkSortChange()},handleMove(t,e){const i=t.detail.y;if(void 0===i)return;const o=Math.min(Math.max(0,Math.round((i+140*e)/140)),this.filteredCollection.length-1);if(o!==e){const t=JSON.parse(JSON.stringify(this.filteredCollection)),[i]=t.splice(e,1);t.splice(o,0,i),this.rawCollection=t,this.activeIndex=o}},checkSortChange(){this.hasChanged=!this.filteredCollection.every(((t,e)=>{var i;return t.id===(null==(i=this.originalOrder[e])?void 0:i.id)}))},async saveSort(){var t=this.rawCollection.filter((t=>this.firstSort.find((e=>e._id==t._id)).sort!=t.sort));console.log("更新内容",t);var i=await Promise.all(t.map((t=>x.collection("web-script-collection").where({id:t.id,host:t.host,collect_id:t.collect_id}).update({sort:parseInt(t.sort)}))));console.log("更新结束",i),e({title:"排序保存成功",icon:"success"}),this.hasChanged=!1,this.firstSort=this.rawCollection.map((t=>({_id:t._id,sort:t.sort})))},async updateCollectionInfo(){if(!this.editForm.name||this.editForm.name.length<2)return e({title:"名称需2-20个字符",icon:"none"});try{await x.collection("web-script-collection-info").doc(this._id).update({name:this.editForm.name,description:this.editForm.description}),this.collectionData={...this.editForm},this.showEditDialog=!1,e({title:"信息更新成功",icon:"success"})}catch(t){console.error(" 更新失败:",t),e({title:"更新失败，请重试",icon:"error"})}},handleDelete(){i({title:"危险操作确认",content:"将永久删除该合集及所有关联数据",confirmColor:"#ff4444",success:async t=>{if(t.confirm)try{await x.collection("web-script-collection").where({collect_id:this._id}).remove(),await x.collection("web-script-collection-info").doc(this._id).remove(),o(),e({title:"删除成功",icon:"success"})}catch(i){console.error(" 删除失败:",i),e({title:"删除操作失败",icon:"error"})}}})},goback(){o({fail:()=>{a({url:"/pages/list/index"})}})}}},[["render",function(t,e,i,o,a,D){const I=C,x=r,F=k(l("uni-icons"),v),j=w,O=b,E=y,H=k(l("bannerScript"),S);return n(),s(x,{class:"container"},{default:c((()=>[d(x,{class:"header",onClick:D.goback},{default:c((()=>[d(I,{class:"title"},{default:c((()=>[h("👈 返回搜脚本加速站")])),_:1})])),_:1},8,["onClick"]),d(x,{class:"main-content"},{default:c((()=>[d(x,{class:"card info-card"},{default:c((()=>[a.showEditDialog?(n(),s(x,{key:1,class:"edit-form"},{default:c((()=>[d(x,{class:"form-item"},{default:c((()=>[d(I,{class:"label"},{default:c((()=>[h("合集名称")])),_:1}),d(j,{modelValue:a.editForm.name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.editForm.name=t),placeholder:"请输入2-20个字符",class:"input",maxlength:"20"},null,8,["modelValue"])])),_:1}),d(x,{class:"form-item"},{default:c((()=>[d(I,{class:"label"},{default:c((()=>[h("合集描述")])),_:1}),d(O,{modelValue:a.editForm.description,"onUpdate:modelValue":e[2]||(e[2]=t=>a.editForm.description=t),placeholder:"请输入描述信息（可选）",class:"textarea",maxlength:"100"},null,8,["modelValue"])])),_:1}),d(x,{class:"form-actions"},{default:c((()=>[d(E,{class:"btn-cancel",onClick:e[3]||(e[3]=t=>a.showEditDialog=!1)},{default:c((()=>[h("取消修改")])),_:1}),d(E,{class:"btn-save",onClick:D.updateCollectionInfo},{default:c((()=>[h("保存更改")])),_:1},8,["onClick"])])),_:1})])),_:1})):(n(),f(p,{key:0},[d(x,{class:"section-header"},{default:c((()=>[d(I,{class:"section-title"},{default:c((()=>[h(u(a.collectionData.name),1)])),_:1}),a.userInfo&&a.userInfo._id==a.collectionData.user_id?(n(),s(F,{key:0,type:"compose",size:"24",class:"edit-icon",onClick:e[0]||(e[0]=t=>a.showEditDialog=!0)})):m("",!0)])),_:1}),d(I,{class:"welcome-text"},{default:c((()=>[h(u(a.collectionData.description||"暂无描述信息"),1)])),_:1})],64))])),_:1}),d(x,{class:"card list-card"},{default:c((()=>[d(x,{class:"list-header"},{default:c((()=>[d(I,{class:"count"},{default:c((()=>[h("📜 包含脚本（"+u(D.filteredCollection.length)+" ）",1)])),_:1})])),_:1}),d(x,{class:"script-item"},{default:c((()=>[(n(!0),f(p,null,_(D.filteredCollection,((t,e)=>(n(),s(H,{item:t,onRefresh:D.loadCollectionInfo,collect:a.collectionData,onSort:D.sort},null,8,["item","onRefresh","collect","onSort"])))),256))])),_:1})])),_:1}),a.userInfo&&a.userInfo._id==a.collectionData.user_id?(n(),s(x,{key:0,class:"card operation-card"},{default:c((()=>[d(x,{class:"action-btns"},{default:c((()=>[d(E,{class:g(["btn-primary",{disabled:!a.hasChanged}]),onClick:D.saveSort,disabled:!a.hasChanged},{default:c((()=>[h(u(a.hasChanged?"保存最新排序":"排序未改变"),1)])),_:1},8,["class","onClick","disabled"]),d(E,{class:"btn-danger",onClick:D.handleDelete},{default:c((()=>[h("删除当前合集")])),_:1},8,["onClick"])])),_:1})])),_:1})):m("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-1c8d562f"]]);export{j as default};
