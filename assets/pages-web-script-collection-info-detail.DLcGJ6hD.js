import{e as t,C as e,u as o,z as i,y as a,l as s,c as l,w as c,i as n,o as r,a as d,b as h,f as m,t as f,A as u,F as p,r as _,G as C,g,M as w,ae as b,$ as y}from"./index-BnZTiJHI.js";import{_ as v}from"./uni-icons.DXdvJWme.js";import{r as I}from"./uni-app.es.CF8X_mXS.js";import{_ as k}from"./bannerScript.D-pejaei.js";import{s as S}from"./store.Bou-8y0P.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-dateformat.CzP1w6ti.js";const x=t.database(),F=x.command;const j=D({components:{bannerScript:k},data:()=>({collectionData:{name:"åŠ è½½ä¸­...",description:""},rawCollection:[],showEditDialog:!1,activeIndex:-1,originalOrder:[],firstSort:[],hasChanged:!1,areaHeight:0,editForm:{name:"",description:""},collectionList:"web-script-collection-info",_id:"",userInfo:null}),computed:{filteredCollection(){return this.rawCollection.filter((t=>!!t.id))}},watch:{filteredCollection:{handler(t){this.calcAreaHeight(t)},immediate:!0}},onLoad(t){this._id=t.id||"67bccc6f47ea33825d4b8d7e",this.initData(),this.userInfo=S.userInfo},methods:{sort(){this.hasChanged=this.rawCollection.filter((t=>{var e=this.firstSort.find((e=>e._id==t._id));return e.sort!=t.sort||e.comment!=t.comment})).length,this.rawCollection.sort(((t,e)=>e.sort-t.sort))},async initData(){await Promise.all([this.loadCollectionInfo(),this.loadScripts()]),this.$nextTick((()=>{this.originalOrder=[...this.filteredCollection]}))},async loadCollectionInfo(){try{const{result:t}=await x.collection("web-script-collection-info").doc(this._id).get();this.collectionData=t.data[0],this.editForm={...t.data[0]}}catch(t){console.error(" åŠ è½½åˆé›†ä¿¡æ¯å¤±è´¥:",t),e({title:"æ•°æ®åŠ è½½å¤±è´¥",icon:"error"})}},async loadScripts(){try{const t=await x.collection("web-script-collection").where({collect_id:this._id}).orderBy("sort","desc").get(),e=t.result.data.map((t=>({id:t.id,host:t.host,show:F.gt(0)})));if(e.length){const o=await x.collection("web-script").where(F.or(e)).field({id:!0,name:!0,description:!0,publisher:!0,"update-id":!0,host:!0,publish_date:!0,day:!0,total:!0,user_id:!0,create_date:!0,version:!0,userContentHtml:!0,changelog:!0,show:!0}).get();this.rawCollection=o.result.data.map((e=>{var o=t.result.data.find((t=>t.id==e.id&&t.host==e.host));return e.sort=o?o.sort:0,e.comment=o?o.comment:0,e})),this.firstSort=this.rawCollection.map((t=>({_id:t._id,sort:t.sort,comment:t.comment}))),this.sort()}}catch(t){console.error(" åŠ è½½è„šæœ¬å¤±è´¥:",t),e({title:"è„šæœ¬åŠ è½½å¤±è´¥",icon:"error"})}},calcAreaHeight(t=[]){this.areaHeight=2015*t.length},handleTouchStart(t){this.activeIndex=t,this.originalOrder=[...this.filteredCollection]},handleTouchEnd(){this.activeIndex=-1,this.checkSortChange()},handleMove(t,e){const o=t.detail.y;if(void 0===o)return;const i=Math.min(Math.max(0,Math.round((o+140*e)/140)),this.filteredCollection.length-1);if(i!==e){const t=JSON.parse(JSON.stringify(this.filteredCollection)),[o]=t.splice(e,1);t.splice(i,0,o),this.rawCollection=t,this.activeIndex=i}},checkSortChange(){this.hasChanged=!this.filteredCollection.every(((t,e)=>{var o;return t.id===(null==(o=this.originalOrder[e])?void 0:o.id)}))},async saveSort(){var t=this.rawCollection.filter((t=>{var e=this.firstSort.find((e=>e._id==t._id));return e.sort!=t.sort||e.comment!=t.comment}));await Promise.all(t.map((t=>x.collection("web-script-collection").where({id:t.id,host:t.host,collect_id:t.collect_id}).update({sort:parseInt(t.sort),comment:t.comment})))),e({title:"è®¾ç½®ä¿å­˜æˆåŠŸ",icon:"success"}),this.hasChanged=!1,this.firstSort=this.rawCollection.map((t=>({_id:t._id,sort:t.sort,comment:t.comment})))},async updateCollectionInfo(){if(!this.editForm.name||this.editForm.name.length<2)return e({title:"åç§°éœ€2-20ä¸ªå­—ç¬¦",icon:"none"});try{await x.collection("web-script-collection-info").doc(this._id).update({name:this.editForm.name,description:this.editForm.description}),this.collectionData={...this.editForm},this.showEditDialog=!1,e({title:"ä¿¡æ¯æ›´æ–°æˆåŠŸ",icon:"success"})}catch(t){console.error(" æ›´æ–°å¤±è´¥:",t),e({title:"æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"error"})}},handleDelete(){o({title:"å±é™©æ“ä½œç¡®è®¤",content:"å°†æ°¸ä¹…åˆ é™¤è¯¥åˆé›†åŠæ‰€æœ‰å…³è”æ•°æ®",confirmColor:"#ff4444",success:async t=>{if(t.confirm)try{await x.collection("web-script-collection").where({collect_id:this._id}).remove(),await x.collection("web-script-collection-info").doc(this._id).remove(),i(),e({title:"åˆ é™¤æˆåŠŸ",icon:"success"})}catch(o){console.error(" åˆ é™¤å¤±è´¥:",o),e({title:"åˆ é™¤æ“ä½œå¤±è´¥",icon:"error"})}}})},goback(){i({fail:()=>{a({url:"/pages/list/index"})}})}}},[["render",function(t,e,o,i,a,S){const D=g,x=n,F=I(s("uni-icons"),v),j=w,O=b,E=y,V=I(s("bannerScript"),k);return r(),l(x,{class:"container"},{default:c((()=>[d(x,{class:"header",onClick:S.goback},{default:c((()=>[d(D,{class:"title"},{default:c((()=>[h("ğŸ‘ˆ è¿”å›æœè„šæœ¬åŠ é€Ÿç«™")])),_:1})])),_:1},8,["onClick"]),d(x,{class:"main-content"},{default:c((()=>[d(x,{class:"card info-card"},{default:c((()=>[a.showEditDialog?(r(),l(x,{key:1,class:"edit-form"},{default:c((()=>[d(x,{class:"form-item"},{default:c((()=>[d(D,{class:"label"},{default:c((()=>[h("åˆé›†åç§°")])),_:1}),d(j,{modelValue:a.editForm.name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.editForm.name=t),placeholder:"è¯·è¾“å…¥2-20ä¸ªå­—ç¬¦",class:"input",maxlength:"20"},null,8,["modelValue"])])),_:1}),d(x,{class:"form-item"},{default:c((()=>[d(D,{class:"label"},{default:c((()=>[h("åˆé›†æè¿°")])),_:1}),d(O,{modelValue:a.editForm.description,"onUpdate:modelValue":e[2]||(e[2]=t=>a.editForm.description=t),placeholder:"è¯·è¾“å…¥æè¿°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰",class:"textarea",maxlength:"100"},null,8,["modelValue"])])),_:1}),d(x,{class:"form-actions"},{default:c((()=>[d(E,{class:"btn-cancel",onClick:e[3]||(e[3]=t=>a.showEditDialog=!1)},{default:c((()=>[h("å–æ¶ˆä¿®æ”¹")])),_:1}),d(E,{class:"btn-save",onClick:S.updateCollectionInfo},{default:c((()=>[h("ä¿å­˜æ›´æ”¹")])),_:1},8,["onClick"])])),_:1})])),_:1})):(r(),m(p,{key:0},[d(x,{class:"section-header"},{default:c((()=>[d(D,{class:"section-title"},{default:c((()=>[h(f(a.collectionData.name),1)])),_:1}),a.userInfo&&a.userInfo._id&&a.userInfo._id==a.collectionData.user_id?(r(),l(F,{key:0,type:"compose",size:"24",class:"edit-icon",onClick:e[0]||(e[0]=t=>a.showEditDialog=!0)})):u("",!0)])),_:1}),d(D,{class:"welcome-text"},{default:c((()=>[h(f(a.collectionData.description||"æš‚æ— æè¿°ä¿¡æ¯"),1)])),_:1})],64))])),_:1}),d(x,{class:"card list-card"},{default:c((()=>[d(x,{class:"list-header"},{default:c((()=>[d(D,{class:"count"},{default:c((()=>[h("ğŸ“œ åŒ…å«è„šæœ¬ï¼ˆ"+f(S.filteredCollection.length)+" ï¼‰",1)])),_:1})])),_:1}),d(x,{class:"script-item"},{default:c((()=>[(r(!0),m(p,null,_(S.filteredCollection,((t,e)=>(r(),l(V,{item:t,onRefresh:S.loadCollectionInfo,collect:a.collectionData,onSort:S.sort},null,8,["item","onRefresh","collect","onSort"])))),256))])),_:1})])),_:1}),a.userInfo&&a.userInfo._id&&a.userInfo._id==a.collectionData.user_id?(r(),l(x,{key:0,class:"card operation-card"},{default:c((()=>[d(x,{class:"action-btns"},{default:c((()=>[d(E,{class:C(["btn-primary",{disabled:!a.hasChanged}]),onClick:S.saveSort,disabled:!a.hasChanged},{default:c((()=>[h(f(a.hasChanged?"ä¿å­˜è®¾ç½®":"æœªä¿®æ”¹"),1)])),_:1},8,["class","onClick","disabled"]),d(E,{class:"btn-danger",onClick:S.handleDelete},{default:c((()=>[h("åˆ é™¤å½“å‰åˆé›†")])),_:1},8,["onClick"])])),_:1})])),_:1})):u("",!0)])),_:1})])),_:1})}],["__scopeId","data-v-5852bbfb"]]);export{j as default};
