import{e as a,h as e,j as t,k as i,n as s,E as o,C as l,s as n,l as r,c,w as d,i as h,o as p,a as u,f as m,r as g,F as y,A as b,b as k,g as f,S as w,G as _,t as v}from"./index-CbIesGMf.js";import{_ as T}from"./uni-icons.Q3foZM-m.js";import{r as C}from"./uni-app.es.BgKzZsuk.js";import{_ as L}from"./uni-search-bar.BnSuaerP.js";import{_ as j}from"./bannerScript.BMtaK8I7.js";import{s as D}from"./uni-status-bar.E9dWOCLv.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-dateformat.CzIQWVVK.js";import"./store.BIjkn5rT.js";const S=a.database(),R=S.command;R.aggregate;const x=F({components:{statusBar:D},computed:{inputPlaceholder:a=>"en"==e("CURRENT_LANG")?"Please enter the search content":"输入搜索词或完整网址",colList(){return[S.collection("web-script").where(this.where).field('id,name,description,"update-id",host,publisher,publish_date,day,total,user_id,create_date,version,show').getTemp(),S.collection("uni-id-users").field("_id,nickname").getTemp()]}},data:()=>({keyword:"1",dataList:[],pagination:{skip:0,limit:20,total:0},loadingType:"more",currentRequest:null,tabs:[{label:"今日安装",value:"today"},{label:"近期热门",value:"hot"},{label:"最近更新",value:"latest"}],activeTab:"today"}),watch:{keyword(a,e){this.handleSearch(a)}},async onReady(){this.listHight="auto"},async onShow(){this.keyword=t().globalData.searchText,this.keyword&&(this.activeTab="today")},onUnload(){this.dataList=[]},methods:{switchTab(a){this.activeTab=a,this.loadData(!0)},searchClick(a){i(),s({url:"/pages/list/search/search",animationType:"fade-in"})},async handleSearch(){this.pagination.skip=0,await this.loadData(!0)},async loadData(e=!1){if("loading"!==this.loadingType){this.loadingType="loading";try{e&&(this.pagination.skip=0,this.dataList=[]);try{var t={type:"getList",data:{skip:this.pagination.skip,limit:this.pagination.limit,show:2,search:this.keyword.trim(),type:this.activeTab}};console.log("发送参数",t);const l=await a.callFunction({name:"web-scripts",data:t});console.log(l.result.data.map((a=>a._id)));var i=await S.collection("web-script").where({_id:R.in(l.result.data.map((a=>a._id)))}).field({name:!0,description:!0,publisher:!0,version:!0,create_date:!0,publish_date:!0,id:!0,"update-id":!0,host:!0,day:!0,total:!0,"name:zh":!0,"description:zh":!0}).get(),s=l.result.data.map((a=>i.result.data.find((e=>e._id==a._id)))).filter((a=>a));this.dataList=e?s:[...this.dataList,...s],this.pagination.total=i.result.total,this.pagination.skip=this.pagination.skip+s.length,this.loadingType=s.length<this.pagination.limit?"noMore":"more",o()}catch(r){this.loadingType="more",l({title:"加载失败",icon:"none"}),o()}n()}catch(r){"AbortError"!==r.name&&(console.error(r),this.loadingType="error")}}},refresh(){this.loadData().then((a=>{n(),console.log("end")}))},loadMore(){this.loadData()},onqueryerror(a){console.error(a)},onpullingdown(a){console.log(a),this.showRefresh=!0,a.pullingDistance>100&&this.refresh()}},onPullDownRefresh(){this.refresh()},onReachBottom(){this.loadMore()}},[["render",function(a,e,t,i,s,o){const l=C(r("uni-icons"),T),n=C(r("uni-search-bar"),L),D=h,F=C(r("bannerScript"),j),S=f,R=w;return p(),c(D,{class:"page-container"},{default:d((()=>[u(D,{class:"search-container",onClick:o.searchClick},{default:d((()=>[u(n,{modelValue:s.keyword,"onUpdate:modelValue":e[0]||(e[0]=a=>s.keyword=a),radius:"30",bgColor:"#FFFFFF",placeholderColor:"#A0AEC0",cancelButton:"none",placeholder:o.inputPlaceholder},{searchIcon:d((()=>[u(l,{type:"search",size:"18",color:"#718096"})])),_:1},8,["modelValue","placeholder"])])),_:1},8,["onClick"]),this.keyword?b("",!0):(p(),c(D,{key:0,class:"nav-container"},{default:d((()=>[(p(!0),m(y,null,g(s.tabs,(a=>(p(),c(D,{key:a.value,class:_(["nav-item",{active:s.activeTab===a.value}]),onClick:e=>o.switchTab(a.value)},{default:d((()=>[k(v(a.label)+" ",1),s.activeTab===a.value?(p(),c(D,{key:0,class:"active-indicator"})):b("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1})),u(R,{onScrolltolower:o.loadMore,"scroll-y":!0},{default:d((()=>[s.dataList.length?(p(!0),m(y,{key:0},g(s.dataList,((a,e)=>(p(),c(F,{key:a._id,item:a},null,8,["item"])))),128)):b("",!0),u(D,{class:"loading-state"},{default:d((()=>["loading"===s.loadingType?(p(),c(D,{key:0,class:"loading-indicator"})):"noMore"===s.loadingType?(p(),m(y,{key:1},[u(l,{type:"checkmarkempty",size:"24",color:"#718096"}),u(S,{class:"tip-text"},{default:d((()=>[k("已经到底啦")])),_:1})],64)):b("",!0)])),_:1})])),_:1},8,["onScrolltolower"])])),_:1})}],["__scopeId","data-v-19b2c895"]]);export{x as default};
