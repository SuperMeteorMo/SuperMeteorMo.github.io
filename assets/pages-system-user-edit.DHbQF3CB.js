import{_ as a,e,$ as t,n as s,N as l,q as o,H as i,s as n,O as r,r as u,a as d,c as m,w as p,i as c,o as f,h,k as b,L as g,t as k,j as D,V as _,p as w,Z as V}from"./index-ChNMzRY4.js";import{_ as x}from"./uni-easyinput.Bwbd5nzK.js";import{_ as y}from"./uni-forms-item.BcVhrZ6O.js";import{_ as A}from"./uni-data-checkbox.DFguk4Fx.js";import{_ as v}from"./uni-forms.DMBatpC-.js";import{v as C}from"./uni-id-users.DFlB41Hw.js";import"./uni-load-more.5Ttyhepy.js";const L=e.database();L.command;function I(a){let e={};for(let t in C)a.includes(t)&&(e[t]=C[t]);return e}const U=a({data:()=>({showPassword:!1,formData:{username:"",nickname:"",password:void 0,role:[],tags:[],authorizedApp:[],mobile:void 0,email:void 0,status:!1},rules:{...I(["username","password","role","mobile","email"]),status:{rules:[{format:"bool"}]}},roles:[],userId:"",appList:[],unknownAppids:[]}),onLoad(a){const e=a.id;this.formDataId=e;let s=t("uni-id-pages-userInfo")||{};this.userId=s._id,this.getDetail(e),this.loadroles()},methods:{gotoAppList(){s({url:"../app/list"})},gotoTagList(){s({url:"../tag/list"})},gotoTagAdd(){s({url:"../tag/add",events:{refreshCheckboxData:()=>{this.$refs.checkboxTags.loadData()}}})},trigger(){this.showPassword=!this.showPassword},submitForm(a){this.$refs.form.submit()},submit(a){const{value:e,errors:t}=a.detail;t||(l({title:"修改中...",mask:!0}),"boolean"==typeof e.status&&(e.status=Number(!e.status)),e.uid=this.formDataId,this.$request("updateUser",e).then((()=>{o({title:"修改成功"});const a=this.getOpenerEventChannel();a.emit&&a.emit("refreshData"),setTimeout((()=>i()),500)})).catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally((a=>{r()})))},resetPWd(a){this.$request("system/user/resetPwd",a).then().catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally()},getDetail(a){l({mask:!0}),L.collection("uni-id-users").doc(a).field("username,nickname,role,dcloud_appid as authorizedApp,tags,mobile,email,status").get().then((a=>{const e=a.result.data[0];e&&(void 0===e.status&&(e.status=!0),0===e.status&&(e.status=!0),1===e.status&&(e.status=!1),this.formData=Object.assign(this.formData,e),this.loadAppList(this.formData.authorizedApp))})).catch((a=>{n({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{r()}))},loadroles(){L.collection("uni-id-roles").limit(500).get().then((a=>{const e=[];this.roles=a.result.data.map((a=>(e.push(a.role_id),{value:a.role_id,text:a.role_name}))),-1===e.indexOf("admin")&&this.roles.unshift({value:"admin",text:"超级管理员"})})).catch((a=>{n({title:"提示",content:a.message,showCancel:!1})}))},loadAppList(a){L.collection("opendb-app-list").limit(500).get().then((e=>{let t=e.result.data.map(((a,e)=>({value:a.appid,text:a.name})));t||(t=[]),a.map((a=>{t.find((e=>e.value===a))||(this.unknownAppids.push(a),t.push({value:a,text:`未知应用${a}`}))})),this.appList=t})).catch((a=>{n({title:"提示",content:a.message,showCancel:!1})}))},parseUserStatus:a=>0===a?"启用":1===a?"禁用":2===a?"审核中":3===a?"审核拒绝":4===a?"已注销":void 0!==a?"未知":"启用"},computed:{unknownAppidsCom(){let a="";return this.unknownAppids.map(((e,t)=>{a+=e,t!==this.unknownAppids.length-1&&(a+="、")})),a}}},[["render",function(a,e,t,s,l,o){const i=u(d("uni-easyinput"),x),n=u(d("uni-forms-item"),y),r=c,C=u(d("uni-data-checkbox"),A),L=_,I=w,U=V,T=u(d("uni-forms"),v);return f(),m(r,{class:"uni-container"},{default:p((()=>[h(T,{ref:"form",modelValue:l.formData,"onUpdate:modelValue":e[13]||(e[13]=a=>l.formData=a),rules:l.rules,validateTrigger:"bind",onSubmit:o.submit},{default:p((()=>[h(n,{name:"username",label:"用户名",required:""},{default:p((()=>[h(i,{modelValue:l.formData.username,"onUpdate:modelValue":e[0]||(e[0]=a=>l.formData.username=a),clearable:!1,placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),h(n,{name:"nickname",label:"用户昵称",required:""},{default:p((()=>[h(i,{modelValue:l.formData.nickname,"onUpdate:modelValue":e[1]||(e[1]=a=>l.formData.nickname=a),clearable:!1,placeholder:"请输入用户昵称"},null,8,["modelValue"])])),_:1}),l.showPassword?(f(),m(n,{name:"password",label:"重置密码",key:"password"},{default:p((()=>[h(i,{modelValue:l.formData.password,"onUpdate:modelValue":e[2]||(e[2]=a=>l.formData.password=a),clearable:!1,placeholder:"请输入重置密码"},{default:p((()=>[h(r,{slot:"right",class:"cancel-reset-password-btn",onClick:o.trigger},{default:p((()=>[b("取消")])),_:1},8,["onClick"])])),_:1},8,["modelValue"])])),_:1})):(f(),m(n,{key:1,label:"重置密码"},{default:p((()=>[g("span",{class:"reset-password-btn",onClick:e[3]||(e[3]=(...a)=>o.trigger&&o.trigger(...a))},"点击重置密码")])),_:1})),h(n,{name:"role",label:"角色列表",class:"flex-center-x"},{default:p((()=>[h(C,{multiple:"",localdata:l.roles,modelValue:l.formData.role,"onUpdate:modelValue":e[4]||(e[4]=a=>l.formData.role=a)},null,8,["localdata","modelValue"])])),_:1}),h(n,{name:"tags",label:"用户标签",labelWidth:"100",class:"flex-center-x"},{default:p((()=>[h(C,{ref:"checkboxTags",multiple:!0,modelValue:l.formData.tags,"onUpdate:modelValue":e[5]||(e[5]=a=>l.formData.tags=a),collection:"uni-id-tag",field:"tagid as value, name as text"},null,8,["modelValue"]),g("span",{class:"link-btn",onClick:e[6]||(e[6]=(...a)=>o.gotoTagAdd&&o.gotoTagAdd(...a))},"新增"),g("span",{class:"link-btn",onClick:e[7]||(e[7]=(...a)=>o.gotoTagList&&o.gotoTagList(...a)),style:{"margin-left":"10px"}},"管理")])),_:1}),h(n,{name:"authorizedApp",label:"可登录应用"},{default:p((()=>[h(r,{class:"uni-forms-item-flex-center-x"},{default:p((()=>[h(C,{multiple:!0,modelValue:l.formData.authorizedApp,"onUpdate:modelValue":e[8]||(e[8]=a=>l.formData.authorizedApp=a),localdata:l.appList},null,8,["modelValue","localdata"]),g("span",{class:"link-btn",onClick:e[9]||(e[9]=(...a)=>o.gotoAppList&&o.gotoAppList(...a))},"管理")])),_:1}),a.formDataId===l.userId?(f(),m(r,{key:0,class:"uni-form-item-tips"},{default:p((()=>[b("当前有未添加的应用"+k(o.unknownAppidsCom)+"，建议点击右侧管理进行添加",1)])),_:1})):D("",!0)])),_:1}),h(n,{name:"mobile",label:"手机号"},{default:p((()=>[h(i,{modelValue:l.formData.mobile,"onUpdate:modelValue":e[10]||(e[10]=a=>l.formData.mobile=a),clearable:!1,placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),h(n,{name:"email",label:"邮箱"},{default:p((()=>[h(i,{modelValue:l.formData.email,"onUpdate:modelValue":e[11]||(e[11]=a=>l.formData.email=a),clearable:!1,placeholder:"请输入邮箱"},null,8,["modelValue"])])),_:1}),h(n,{name:"status",label:"用户状态"},{default:p((()=>[Number(l.formData.status)<2?(f(),m(L,{key:0,onChange:e[12]||(e[12]=e=>a.binddata("status",e.detail.value)),checked:l.formData.status,disabled:a.formDataId===l.userId},null,8,["checked","disabled"])):(f(),m(r,{key:1,class:"uni-form-item-empty"},{default:p((()=>[b(k(o.parseUserStatus(l.formData.status)),1)])),_:1})),a.formDataId===l.userId?(f(),m(r,{key:2,class:"uni-form-item-tips"},{default:p((()=>[b("请勿禁用当前登录的账号")])),_:1})):D("",!0)])),_:1}),h(r,{class:"uni-button-group"},{default:p((()=>[h(I,{style:{width:"100px"},type:"primary",class:"uni-button",onClick:o.submitForm},{default:p((()=>[b(k(a.$t("common.button.submit")),1)])),_:1},8,["onClick"]),h(U,{"open-type":"navigateBack",style:{"margin-left":"15px"}},{default:p((()=>[h(I,{style:{width:"100px"},class:"uni-button"},{default:p((()=>[b(k(a.$t("common.button.back")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"])])),_:1})}],["__scopeId","data-v-fffd0daf"]]);export{U as default};
