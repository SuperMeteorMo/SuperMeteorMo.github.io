import{g as e,h as s,ax as n,C as o,q as i,v as t,a8 as r,a2 as a,ay as u,X as l,y as d,a7 as c,z as g,an as f}from"./index-BlSR6jVG.js";const p=e.importObject("uni-id-co"),I=e.database().collection("uni-id-users");let h=s("uni-id-pages-userInfo")||{};const w={userInfo:h,hasLogin:0!=Object.keys(h).length},m={async updateUserInfo(s=!1){if(s)I.where("_id==$env.uid").update(s).then((e=>{e.result.updated?(o({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(s)):o({title:"没有改变",icon:"none",duration:3e3})}));else{const s=e.getCurrentUserInfo().uid;this.setUserInfo({_id:s},{cover:!0});const o=e.importObject("uni-id-co",{customUI:!0});try{let e=await I.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();const s=await o.getRealNameInfo();this.setUserInfo({...e.result.data[0],realNameAuth:s})}catch(n){this.setUserInfo({},{cover:!0}),console.error(n.message,n.errCode)}}},setUserInfo(e,{cover:s}={cover:!1}){let n=s?e:Object.assign(U.userInfo,e);return U.userInfo=Object.assign({},n),U.hasLogin=0!=Object.keys(U.userInfo).length,i("uni-id-pages-userInfo",U.userInfo),e},async logout(){if(e.getCurrentUserInfo().tokenExpired>Date.now())try{await p.logout()}catch(s){console.error(s)}t("uni_id_token"),i("uni_id_token_expired",0),this.setUserInfo({},{cover:!0}),r("uni-id-pages-logout"),a({url:`/${u.uniIdRouter&&u.uniIdRouter.loginPage?u.uniIdRouter.loginPage:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`})},loginBack(e={}){const{uniIdRedirectUrl:s=""}=e;let n=0,o=l();if(o.forEach(((e,s)=>{"login"==o[o.length-s-1].route.split("/")[3]&&n++})),s)return a({url:s,fail:e=>{d({url:s,fail:s=>{console.log(e,s)}})}});if("weixin"==e.loginType)return window.history.go(-3);if(n){const e=u.pages[0];return c({url:`/${e.path}`})}g({delta:n})},loginSuccess(e={}){const{showToast:s=!0,toastText:n="登录成功",autoBack:i=!0,uniIdRedirectUrl:t="",passwordConfirmed:u}=e;if(s&&o({title:n,icon:"none",duration:3e3}),this.updateUserInfo(),r("uni-id-pages-login-success"),f.setPasswordAfterLogin&&!u)return a({url:t?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${t}&loginType=${e.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,fail:e=>{console.log(e)}});i&&this.loginBack({uniIdRedirectUrl:t})}},U=n(w);export{m,U as s};
